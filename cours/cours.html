<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Développement Web Moderne | EduLearn</title>
    <link rel="stylesheet" href="cours.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>

<body>

    <header class="header">
        <a href="../index.html" class="logo" style="text-decoration: none;">Edu<span>Learn</span></a>
        <nav class="nav">
            <a href="../index.html" class="btn-acceuil">Accueil</a>
            <a href="listecours.html" class="btn-cours">Cours</a>
            <a href="../auth/login.html" class="btn-login">Se connecter</a>
        </nav>
    </header>

    <section class="course-hero">
        <h1>Chargement du cours...</h1>
        <p></p>
    </section>

    <!-- ===== CONTENU DU COURS ===== -->
    <section id="course-content-section" class="course-container" style="display: none;">
        <!-- ===== MENU LATÉRAL ===== -->
        <aside class="course-menu">
            <ul>
                <li><a href="#" class="active" onclick="loadContent('videos')"><i class='bx bx-video'></i> Vidéos</a>
                </li>
                <li><a href="#" onclick="loadContent('docs')"><i class='bx bx-file'></i> Documents</a></li>
                <li><a href="#" onclick="loadContent('forum')"><i class='bx bx-message-rounded-dots'></i> Forum</a></li>
                <li><a href="#" onclick="loadContent('quiz')"><i class='bx bx-task'></i> Quiz</a></li>
            </ul>
        </aside>

        <!-- ===== CONTENU PRINCIPAL ===== -->
        <main class="course-main-content">
            <div id="dynamic-content">
                <h3>Bienvenue dans le cours !</h3>
                <p>Sélectionnez une section à gauche pour commencer votre apprentissage.</p>
            </div>
        </main>
    </section>

    <footer class="footer">
        <p>© 2026 EduLearn – Plateforme e-learning</p>
    </footer>

    <script>
        const API_URL = 'http://localhost:3000/api';
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');

        // Vérifier l'authentification et l'inscription
        async function initCourse() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '../auth/login.html';
                return;
            }

            if (!courseId) {
                alert('Aucun cours sélectionné');
                window.location.href = 'listecours.html';
                return;
            }

            try {
                // 1. Récupérer les infos du cours
                const courseRes = await fetch(`${API_URL}/courses/${courseId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const courseData = await courseRes.json();

                if (!courseData.success) throw new Error('Cours introuvable');

                const course = courseData.data;
                document.querySelector('.course-hero h1').textContent = course.title;
                document.querySelector('.course-hero p').textContent = course.description;

                // 2. Vérifier si l'utilisateur est inscrit
                const userRes = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const userData = await userRes.json();

                // Si Admin ou Enseignant du cours -> Accès direct
                if (userData.user.role === 'admin' || (userData.user.role === 'teacher' && course.teacher._id === userData.user._id)) {
                    showContent();
                    return;
                }

                // Vérifier liste des cours inscrits
                const userDetailsRes = await fetch(`${API_URL}/users/${userData.user._id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const userDetails = await userDetailsRes.json();

                const isEnrolled = userDetails.data.enrolledCourses.some(c => c._id === courseId || c === courseId);

                if (isEnrolled) {
                    showContent();
                } else {
                    // REDIRECTION VERS LA PAGE D'INSCRIPTION
                    window.location.href = `enroll.html?id=${courseId}`;
                }

            } catch (error) {
                console.error(error);
                alert('Erreur lors du chargement du cours');
            }
        }

        function showContent() {
            document.getElementById('course-content-section').style.display = 'flex';
        }

        // Gestion du contenu dynamique (placeholder pour l'instant)
        window.loadContent = function (type) {
            // Ici on pourrait charger videos.html, etc. via fetch ou iframe, 
            // ou simplement rediriger vers les pages dédiées avec l'ID
            if (type === 'videos') window.location.href = `videos.html?id=${courseId}`;
            else if (type === 'docs') window.location.href = `docs.html?id=${courseId}`;
            else if (type === 'forum') window.location.href = `forum.html?id=${courseId}`;
            else if (type === 'quiz') window.location.href = `quiz.html?id=${courseId}`;
        };

        // Init
        document.addEventListener('DOMContentLoaded', initCourse);
    </script>
</body>

</html>