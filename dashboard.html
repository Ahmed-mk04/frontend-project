<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Dashboard | EduLearn</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>

<body>

    <!-- ===== HEADER ===== -->
    <header class="header">
        <a href="index.html" class="logo" style="text-decoration: none;">Edu<span>Learn</span></a>
        <nav class="nav">
            <a href="index.html" class="btn-acceuil">Accueil</a>
            <a href="cours/listecours.html" class="btn-cours">Cours</a>
            <a href="profil.html" class="btn-profile">Profil</a>
            <a href="tarifs.html" class="btn-tarifs">Abonnements</a>
            <a href="contact/contact.html" class="btn-contact">Contact</a>
            <a href="#" class="btn-login" onclick="logout(event)">Se dÃ©connecter</a>
            <!-- TODO Node.js : afficher Se connecter / Se dÃ©connecter selon session -->
        </nav>
    </header>

    <!-- ===== DASHBOARD ===== -->
    <section class="courses-dashboard">
        <h1>ðŸ“Š Mes cours</h1>

        <div class="courses-grid" id="coursesGrid">
            <!-- Les cours inscrits seront chargÃ©s ici -->
            <p style="text-align: center; width: 100%;">Chargement de vos cours...</p>
        </div>
    </section>

    <!-- ===== FOOTER ===== -->
    <footer class="footer">
        <p>Â© 2026 EduLearn â€“ Plateforme e-learning</p>
    </footer>

    <script>
        // Configuration
        const API_URL = 'http://localhost:3000/api';

        // Helper pour les appels API
        async function apiCall(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('token');

            if (!token) {
                window.location.href = 'auth/login.html';
                return null;
            }

            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            if (body) options.body = JSON.stringify(body);

            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                if (response.status === 401) {
                    // Token expirÃ© ou invalide
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'auth/login.html';
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        // Charger les informations de l'Ã©tudiant et ses cours
        async function initDashboard() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = 'auth/login.html';
                return;
            }

            if (!user) {
                window.location.href = 'auth/login.html';
                return;
            }

            // VÃ©rifier le rÃ´le
            if (user.role !== 'student') {
                if (user.role === 'admin') window.location.href = 'dashboard-admin.html';
                else if (user.role === 'teacher') window.location.href = 'enseignant.html';
                return;
            }

            // Mettre Ã  jour l'interface
            try {
                // RÃ©cupÃ©rer les donnÃ©es fraÃ®ches de l'utilisateur
                const meRes = await apiCall('/auth/me');
                if (!meRes || !meRes.user) throw new Error('Utilisateur non trouvÃ©');

                const userId = meRes.user._id;
                // Fetch full details including enrolled courses
                const userDetails = await apiCall(`/users/${userId}`);

                if (userDetails && userDetails.data) {
                    displayCourses(userDetails.data.enrolledCourses || []);
                } else {
                    displayCourses([]);
                }
            } catch (error) {
                console.error("Dashboard error:", error);
                // Optionally redirect to login if auth failed
                if (error.message.includes('non trouvÃ©') || error.message.includes('401')) {
                    logout();
                } else {
                    displayCourses([]); // Show empty state on error
                }
            }
        }

        function displayCourses(courses) {
            const container = document.getElementById('coursesGrid');

            if (!courses || courses.length === 0) {
                container.innerHTML = `
                <div class="no-courses">
                    <p>Vous n'Ãªtes inscrit Ã  aucun cours pour le moment.</p>
                    <a href="cours/listecours.html" class="btn btn-primary" style="margin-top: 15px; display: inline-block;">DÃ©couvrir les cours</a>
                </div>
            `;
                return;
            }

            container.innerHTML = courses.map(course => `
            <div class="course-card">
                <h3>${course.title}</h3>

                <div class="progress-bar">
                    <div class="progress" style="width: 0%;"></div>
                </div>

                <p>Progression : 0%</p>
                <a href="cours/cours.html?id=${course._id}" class="btn btn-details">Continuer le cours</a>
            </div>
        `).join('');
        }

        function logout(e) {
            if (e) e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'auth/login.html';
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>

</html>